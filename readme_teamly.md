# User Creator (.exe версия)

Графическое приложение для обработки CSV-файлов с данными пользователей, генерации XML-файлов в форматах Access и Energy, и (опционально) интеграции с Active Directory.

Этот документ описывает, как использовать собранную версию приложения в виде исполняемого файла `UserCreator.exe`.

## Содержимое дистрибутива

После распаковки архива с приложением вы найдете следующие файлы и папки:

*   `UserCreator.exe`: Основной исполняемый файл приложения.
*   config/
    *   `config.json`: Файл конфигурации приложения. **Обязателен** для работы.
    *   `logging_config.json`: Файл конфигурации системы логирования. **Обязателен** для работы.
*   Папка `PyQt5` и другие папки/файлы: Зависимости, необходимые для работы приложения (создаются PyInstaller).

## Требования к системе

*   Операционная система Windows (Windows 7/8/10/11 и соответствующие серверные версии).
*   Права на запись в директорию, где находится `UserCreator.exe` (для создания логов и выходных файлов).

## Быстрый старт

1.  Распакуйте архив с приложением в любую папку на вашем компьютере.
2.  Убедитесь, что файлы `config.json` и `logging_config.json` находятся в **той же папке**, что и `UserCreator.exe`.
3.  Настройте `config.json` под вашу среду (см. раздел "Конфигурация").
4.  Подготовьте CSV-файлы с данными пользователей и поместите их в отдельную папку.
5.  Дважды щелкните `UserCreator.exe` или запустите его из командной строки.
6.  Следуйте инструкциям в графическом интерфейсе.

## Конфигурация

### `config.json`

Основной файл конфигурации приложения.

**Важно:** Перед первым запуском необходимо отредактировать этот файл и внести правильные данные для вашей среды.

Пример структуры:
```json
{
  "ad": {
    "enabled": true,
    "domain_controller": "your.domain.controller.com",
    "domain_dn": "DC=your,DC=domain,DC=com",
    "user": "CN=service_account,OU=Service Accounts,DC=your,DC=domain,DC=com"
  },
  "input": {
    "encoding": "windows-1251",
    "delimiter": ";"
  },
  "output": {
    "log_dir": "log",
    "not_in_ad_csv": "not_in_AD.csv",
    "Access_xml_suffix": "_Access.xml",
    "energy_xml_suffix": "_Energy.xml"
  },
  "xml": {
    "model_version_Access": "2025-03-04(11.7.1.7)",
    "model_version_energy": "1.0"
  }
}
```
- `ad.enabled`: Установите `true`, чтобы включить интеграцию с Active Directory, или `false`, чтобы работать без AD.
- `ad.domain_controller`: Адрес контроллера домена Active Directory (например, `dc1.company.local`).
- `ad.domain_dn`: отличительное имя корня вашего домена (например, `DC=company,DC=local`).
- `ad.user`: Полный DN учетной записи службы, используемой для подключения к AD (например, `CN=svc_user_creator,OU=Service Accounts,DC=company,DC=local`).
- `input.encoding`: Кодировка входных CSV-файлов (по умолчанию `windows-1251`).
- `input.delimiter`: Разделитель в CSV-файлах (по умолчанию `;`).
- `output.log_dir`: Относительный путь к каталогу для сохранения лог-файлов (например, `log` создаст папку `log` рядом с `.exe`).
- `output.not_in_ad_csv`: Имя файла для сохранения списка пользователей, не найденных в AD.
- `output.Access_xml_suffix`: Суффикс для создаваемых XML-файлов Access.
- `output.energy_xml_suffix`: Суффикс для генерируемых XML-файлов Energy.
- `xml.model_version_Access`: Версия модели для XML Access.
- `xml.model_version_energy`: Версия модели для XML Energy.

### `logging_config.json`

Файл конфигурации стандартной библиотеки логирования Python (`logging`). Определяет форматтеры и базовые обработчики (например, консольный вывод).

Обычно не требует изменений, если только вы не хотите изменить формат журналов или добавить дополнительные обработчики. Файловые обработчики `app_*.log`, `errors_*.log` и `{csv}_*.log` настраиваются программно.

## Использование приложения

1. **Запуск**: дважды щелкните `UserCreator.exe` или запустите его из командной строки (`cmd`).
2. **Выбор режима**:
    - **Использовать AD**: приложение будет подключаться к Active Directory для получения GUID домена и пользователей. Требуется ввести пароль учетной записи из `config.json`.
    - **Без AD (вручную)**: приложение использует GUID домена, введенный вручную. GUID пользователей берутся из CSV-файла или генерируются автоматически.
3. **Ввод данных**:
    - В режиме «Использовать AD»: введите пароль учетной записи AD.
    - В режиме «Без AD»: введите идентификатор GUID домена.
4. **Выбор каталога**: нажмите кнопку «Обзор...» и выберите папку, содержащую CSV-файлы для обработки.
5. **Запуск обработки**: нажмите кнопку «▶ Запустить обработку».
6. **Мониторинг**: ход выполнения отображается на индикаторе выполнения и в области логов в режиме реального времени.
7. **Завершение**: по завершении обработки появится сообщение «✅ Обработка всех файлов завершена!».

## Подготовка CSV-файлов

Поместите CSV-файлы с данными пользователей в отдельную папку. Приложение обработает все файлы с расширением `.csv` в выбранной директории (кроме `Sample.csv` и файла `not_in_ad_csv` из конфигурации).

Ожидаемые столбцы (многие из них необязательны):

- `name` (обязательно): полное имя пользователя.
- `login`: Логин пользователя (для поиска в AD).
- `person_guid`: идентификатор GUID пользователя (если не используется AD или пользователь не найден).
- `email`: Электронная почта.
- `mobilePhone`: Мобильный телефон.
- `position`: Должность.
- `OperationalAuthorities`: Оперативные полномочия (разделитель `!`).
- `electrical_safety_level`: Уровень электробезопасности.
- `roles`: Роли (разделитель `!`).
- `groups`: Группы (разделитель `!`).
- `parent_energy`: Родительский объект для Energy.
- `parent_Access`: Родительский объект для Access.

## Выходные данные

После обработки в папке с CSV-файлами будут созданы:

- XML-файлы для каждого CSV-файла (с суффиксами `config.json`).
- Обновлённые CSV-файлы с добавленными/обновлёнными GUID.
- Файл `not_in_AD.csv` (если включен режим AD и есть не найденные пользователи).

Логи приложения создаются в директории, указанной в `config.json` (`output.log_dir`):

- `app_YYYY-MM-DD.log`: Основной журнал работы приложения.
- `errors_YYYY-MM-DD.log`: Лог ошибок.
- `{имя_csv}_YYYY-MM-DD.log`: Журнал обработки конкретного CSV-файла.
- `user_creator_ui_YYYY-MM-DD.log`: Журнал работы графического интерфейса.

## Устранение неполадок

- **Приложение не запускается**: убедитесь, что все файлы дистрибутива находятся в одной папке. Проверьте, не блокирует ли антивирус выполнение `.exe`.
- **Ошибки в конфигурации**: проверьте правильность путей и данных в `config.json`. Убедитесь, что формат JSON корректен.

- **Ошибки при подключении к AD**: проверьте параметры подключения в `config.json`, доступность контроллера домена и правильность учётных данных.
- **Ошибки при обработке файлов**: проверьте формат CSV-файлов, кодировку и разделители. Для получения подробной информации об ошибках просмотрите логи.
- **Журналы не создаются**: проверьте права доступа на запись в каталог приложения и каталог, указанный в `output.log_dir`.