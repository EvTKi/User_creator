# Импорт/экспорт пользователей: конвертация CSV → XML и обратное обновление person_guid

## Описание

Этот PowerShell-скрипт используется для массовой обработки CSV-файлов пользователей:
- Генерирует XML-файлы (`sysconfig.xml` и `energy.xml`) на основе данных из CSV
- Если в строке отсутствует GUID пользователя (`person_guid`), он автоматически генерируется для этой строки
- Итоговый person_guid записывается обратно в исходный CSV-файл
- **Если в CSV присутствуют поля email и/или mobilePhone, они попадут в итоговый XML-файл:**
  - email — в блок `<cim:Person.electronicAddress><cim:ElectronicAddress.email1>…</cim:ElectronicAddress.email1>`
  - mobilePhone — в блок `<cim:Person.mobilePhone><cim:TelephoneNumber.localNumber>…</cim:TelephoneNumber.localNumber>`

## Формат исходного CSV

- **Кодировка:**  
  CSV можно сохранять в UTF-8 (с BOM или без) или Windows-1251. Скрипт автоматически определяет кодировку.

- **Разделитель:**  
  Скрипт автоматически определяет разделитель (`;` или `,`).

- **Заголовок и поля:**

| Колонка          | Описание                                                       |
| ---------------- | -------------------------------------------------------------- |
| name             | ФИО пользователя (например, Иванов Иван Иванович)              |
| login            | Логин пользователя                                             |
| email            | Электронная почта (опционально, попадёт в XML как email1)      |
| mobilePhone      | Мобильный телефон (опционально, попадёт в XML как localNumber) |
| person_guid      | GUID пользователя (может быть пустым — заполнится скриптом)    |
| parent_energy    | GUID родителя для energy.xml                                   |
| parent_sysconfig | GUID родителя для sysconfig.xml                                |

**Пример содержимого:**

| name                             | login          | email        | mobilePhone | person_guid | parent_energy                        | parent_sysconfig                     |
| -------------------------------- | -------------- | ------------ | ----------- | ----------- | ------------------------------------ | ------------------------------------ |
| Буханов Андрей Юрьевич           | Bukhanov.Ayu   | ayu@mail.ru  | 9110001010  |             | f0eb1cfb-7939-46e2-b36a-ba316b109a56 | 74f289ae-0eb9-4341-8912-8e211f4c01f9 |
| Алексенцев Александр Геннадьевич | Sokolov.Sni    | asni@mail.ru | 9215050011  |             | f0eb1cfb-7939-46e2-b36a-ba316b109a56 | 74f289ae-0eb9-4341-8912-8e211f4c01f9 |
| Михайлова Анна Сергеевна         | Mikhaylova.Ase |              |             |             | f0eb1cfb-7939-46e2-b36a-ba316b109a56 | 74f289ae-0eb9-4341-8912-8e211f4c01f9 |

*Поля email и mobilePhone могут быть опущены или оставаться пустыми — в этом случае соответствующие XML-блоки отсутствуют.*

*Если `person_guid` пуст, он будет автоматически сгенерирован и подставлен скриптом в итоговый CSV.*

---

## Как использовать скрипт

1. Поместите один или несколько CSV-файлов в рабочую папку со скриптом.
2. Запустите скрипт PowerShell (**от имени пользователя с правами записи в директорию!**).
3. Дайте ответ на вопрос "Требуется добавлять пользователей из домена? (Y/N)"
4. При положительном ответе данные будут скопированы из домена.
5. При отрицательном ответе необходимо ввести GUID домена (adGuid), когда появится запрос.
6. Скрипт создаст для каждого исходного CSV два XML-файла (sysconfig.xml, energy.xml).
7. Если в строках не было указан person_guid, он впишется обратно в CSV автоматически.
8. Итоговый CSV сохранится **в той же кодировке**, что был исходный.

---

## Результаты

- Каждый исходный CSV будет обновлен: теперь в поле `person_guid` у всех строк будет заполнен реальный GUID.
- В каждой папке появятся файлы:
    - `[исходный].sysconfig.xml`
    - `[исходный].energy.xml`
- Если заполнено поле email — оно появится в XML `<cim:ElectronicAddress.email1>`.
- Если заполнено поле mobilePhone — оно появится в XML `<cim:TelephoneNumber.localNumber>`.

---

## Особенности

- **Кириллица и русские буквы поддерживаются** — скрипт работает с UTF-8 и Windows-1251.
- Если в файле были уже заполнены person_guid, они сохраняются без изменений.
- Скрипт распознаёт разделитель, так что можно использовать как `;`, так и `,`.
- Итоговые XML всегда сохраняются в формате UTF-8.

---

## Требования

- PowerShell 5.1 или выше
- Права на запись файлов в директории CSV

---

## Примечания

- Если CSV выглядит поврежденным после обработки (например, не читается Excel), убедитесь, что у исходного файла не было нестандартных символов и строка заголовка соответствует примеру выше.
- Для максимальной совместимости используйте Notepad++ или VS Code при подготовке CSV.

---
