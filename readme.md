# Импорт/экспорт пользователей: конвертация CSV → XML и обратное обновление person_guid

## Описание

Этот PowerShell-скрипт используется для массовой обработки CSV-файлов пользователей:
- Генерирует XML-файлы (`sysconfig.xml` и `energy.xml`) на основе данных из CSV
- Если в строке отсутствует GUID пользователя (`person_guid`), он автоматически генерируется для этой строки
- Итоговый person_guid записывается обратно в исходный CSV-файл
- **Если в CSV присутствуют поля email, mobilePhone, position, OperationalAuthorities или electrical_safety_level, они попадут в итоговый XML-файл:**
  - email — в блок `<cim:Person.electronicAddress><cim:ElectronicAddress.email1>…</cim:ElectronicAddress.email1>`
  - mobilePhone — в блок `<cim:Person.mobilePhone><cim:TelephoneNumber.localNumber>…</cim:TelephoneNumber.localNumber>`
  - position — в блок `<me:Person.Position rdf:resource='#_значение'/>`
  - OperationalAuthorities — по каждому uid в списке (через "!") по строке `<cim:Person.operationalAuthority rdf:resource="#_uid" />`
  - electrical_safety_level — в блоке `<me:Person.ElectricalSafetyLevel rdf:resource="#_значение"/>`
- **Для каждого пользователя формируется отдельный блок `<cim:Name ...>`. Ссылка на этот блок добавляется в `<cim:Person ...>` через строку `<cim:IdentifiedObject.Names rdf:resource="#_$guid"/>`.**
- **Любые строки, где поле `name` пусто или состоит только из пробелов, а также Sample.csv, игнорируются и не попадают ни в XML, ни в CSV.**
- **Независимо от исходной кодировки CSV (UTF-8, UTF-16, Windows-1251), файл пересохраняется во временный файл в Windows-1251 для гарантированной поддержки кириллицы и корректной работы в Excel.**

## Формат исходного CSV

- **Кодировка:**  
  CSV можно сохранять в UTF-8 (с BOM или без) или Windows-1251. Скрипт автоматически определяет и преобразует исходный файл в нужную кодировку.

- **Разделитель:**  
  Скрипт автоматически определяет разделитель (`;` или `,`).

- **Заголовок и поля:**

| Колонка                 | Описание                                                                                    |
| ----------------------- | ------------------------------------------------------------------------------------------- |
| name                    | ФИО пользователя (например, Иванов Иван Иванович)                                           |
| login                   | Логин пользователя                                                                          |
| email                   | Электронная почта (опционально, попадёт в energy.xml как email1)                            |
| mobilePhone             | Мобильный телефон (опционально, попадёт в energy.xml как localNumber)                       |
| position                | GUID должности (опционально, попадёт в energy.xml как Position)                             |
| roles                   | Список GUID ролей через `!`(опционально, попадёт в sysconfig.xml как Roles)                 |
| groups                  | Список GUID групп пользователей через `!` (опционально, попадёт в sysconfig.xml как Groups) |
| OperationalAuthorities  | Список GUID полномочий через `!` (energy.xml — массив блоков operationalAuthority)          |
| electrical_safety_level | GUID уровня электробезопасности (опционально, energy.xml — ElectricalSafetyLevel)           |
| person_guid             | GUID пользователя (может быть пустым — заполнится скриптом)                                 |
| parent_energy           | GUID родителя для energy.xml                                                                |
| parent_sysconfig        | GUID родителя для sysconfig.xml                                                             |

**Пример содержимого:**

| name                             | login          | email        | mobilePhone | position                             | roles                                                                     | groups                               | OperationalAuthorities                                                    | electrical_safety_level              | person_guid                          | parent_energy                        | parent_sysconfig                     |
| -------------------------------- | -------------- | ------------ | ----------- | ------------------------------------ | ------------------------------------------------------------------------- | ------------------------------------ | ------------------------------------------------------------------------- | ------------------------------------ | ------------------------------------ | ------------------------------------ | ------------------------------------ |
| Буханов Андрей Юрьевич           | Bukhanov.Ayu   | ayu@mail.ru  | 9110001010  | 62c05a53-0b27-4a62-b958-c24840a13c30 |                                                                           |                                      | 62c05a53-0b27-4a62-b958-c24840a13c30!62c05a53-0b27-4a62-b958-c24840a13c30 | 62c05a53-0b27-4a62-b958-c24840a13c30 |                                      | f0eb1cfb-7939-46e2-b36a-ba316b109a56 | 74f289ae-0eb9-4341-8912-8e211f4c01f9 |
| Алексенцев Александр Геннадьевич | Sokolov.Sni    | asni@mail.ru | 9215050011  |                                      | 62c05a53-0b27-4a62-b958-c24840a13c30                                      | 62c05a53-0b27-4a62-b958-c24840a13c30 |                                                                           | 62c05a53-0b27-4a62-b958-c24840a13c30 | 62c05a53-0b27-4a62-b958-c24840a13c30 | f0eb1cfb-7939-46e2-b36a-ba316b109a56 | 74f289ae-0eb9-4341-8912-8e211f4c01f9 |
| Михайлова Анна Сергеевна         | Mikhaylova.Ase |              |             |                                      | 62c05a53-0b27-4a62-b958-c24840a13c30!62c05a53-0b27-4a62-b958-c24840a13c30 |                                      |                                                                           |                                      |                                      | f0eb1cfb-7939-46e2-b36a-ba316b109a56 | 74f289ae-0eb9-4341-8912-8e211f4c01f9 |

*Поля email, mobilePhone, position, roles. groups OperationalAuthorities, electrical_safety_level могут быть опущены или оставаться пустыми — в этом случае соответствующие XML-блоки отсутствуют.*

*Если `person_guid` пуст, он будет автоматически сгенерирован и подставлен скриптом в итоговый CSV.*

*Строки, где поле `name` пустое или состоит только из пробелов, игнорируются скриптом.*

---

## Как использовать скрипт

1. Поместите один или несколько CSV-файлов в рабочую папку со скриптом (файл `Sample.csv` всегда игнорируется автоматически).
2. Запустите скрипт PowerShell (**от имени пользователя с правами записи в директорию!**).
3. Введите GUID домена (adGuid), когда появится запрос.
6. Скрипт создаст для каждого исходного CSV два XML-файла (`sysconfig.xml`, `energy.xml`).
7. Если в строках не было указан `person_guid`, он впишется обратно в CSV автоматически.
8. Итоговый CSV сохранится **в кодировке Windows-1251** для идеальной совместимости с Excel.

---

## Результаты

- Каждый обработанный CSV будет обновлен: теперь в поле `person_guid` у всех строк будет заполнен реальный GUID.
- В каждой папке появятся файлы:
    - `[исходный].sysconfig.xml`
    - `[исходный].energy.xml`
- Если заполнено поле email — оно появится в XML `<cim:ElectronicAddress.email1>`.
- Если заполнено поле mobilePhone — оно появится в XML `<cim:TelephoneNumber.localNumber>`.
- Если заполнено поле position — в каждом блоке `<cim:Person ...>` появится `<me:Person.Position rdf:resource="#_значение"/>`.
- Если заполнено поле roles — в каждом блоке `<cim:User ...>` появится `<cim:Principal.Roles rdf:resource="#_значение" />`.
- Если заполнено поле groups — в каждом блоке `<cim:User ...>` появится `<cim:Principal.Groups rdf:resource="#_значение" />`.
- Если заполнено поле OperationalAuthorities — в каждом блоке `<cim:Person ...>` появятся строки вида `<cim:Person.operationalAuthority rdf:resource="#_uid"/>` для каждого uid.
- Если заполнено поле electrical_safety_level — в каждом блоке `<cim:Person ...>` появится `<me:Person.ElectricalSafetyLevel rdf:resource="#_значение"/>`.
- Для каждого пользователя появится отдельный блок `<cim:Name ...>` с отдельным GUID и сокращённым ФИО, а внутри блока Person будет ссылка `<cim:IdentifiedObject.Names rdf:resource="#_GUID"/>` на соответствующий Name.
- **Строки без значения name (или если name только из пробелов) будут полностью проигнорированы и не попадут в экспортируемые файлы.**
- **`Sample.csv` всегда пропускается.**

---

## Особенности

- **Кириллица и русские буквы полностью поддерживаются** — весь поток-обработка идёт через Windows-1251 для итоговых CSV.
- Если были заполнены значения `person_guid`, они сохраняются без изменений.
- Скрипт определяет разделитель — можно использовать как `;`, так и `,`.
- Итоговые XML всегда сохраняются в кодировке UTF-8.

---

## Требования

- PowerShell 5.1 или выше
- Права на запись файлов в директории CSV

---

## Примечания

- Если CSV после обработки выглядит поврежденным (например, не читается в Excel), убедитесь, что нет нестандартных символов в строках и заголовках, а структура соответствует примеру выше.
- Для лучшей совместимости используйте редакторы Notepad++ или VS Code для просмотра и подготовки CSV.

---
